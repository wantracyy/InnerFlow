{% extends 'base_app.html' %}

{% block title %}
–ì–ª–∞–≤–Ω–∞—è | InnerFlow
{% endblock %}

{% block content %}
<div class="layout-container">
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div class="compact-calendar">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div class="calendar-nav">
            <button class="nav-btn" id="prevMonth">
                <i class="fas fa-chevron-left"></i>
            </button>

            <div class="month-year" id="currentMonthYear">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>

            <button class="nav-btn" id="nextMonth">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
        <div class="calendar-grid" id="calendarGrid">
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
        </div>
    </div>

    <!-- –ë–æ–ª—å—à–æ–π —á–∞—Ç —Å –ò–ò -->
    <div class="expanded-chat">
        <div class="chat-header">
            <div class="message-header">
                <i class="fas fa-robot me-2"></i>–ò–ò –ü–æ–º–æ—â–Ω–∏–∫
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message ai-message">
                <div class="message-content">
                    <p>–ü—Ä–∏–≤–µ—Ç! üëã –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!</p>
                    <p>–ö–∞–∫ —Ç–≤–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è? –•–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –º—ã—Å–ª—è–º–∏ –∏–ª–∏ —á—É–≤—Å—Ç–≤–∞–º–∏?</p>
                </div>
                <div class="message-time">—Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
            </div>
        </div>

        <div class="quick-questions">
            <div class="questions-title">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</div>
            <div class="questions-grid">
                <button class="question-btn" data-question="–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?">
                    –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?
                </button>
                <button class="question-btn" data-question="–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ?">
                    –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ?
                </button>
                <button class="question-btn" data-question="–ö–∞–∫ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Ç—Ä–µ–≤–æ–≥–æ–π?">
                    –ö–∞–∫ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Ç—Ä–µ–≤–æ–≥–æ–π?
                </button>
                <button class="question-btn" data-question="–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —Ç–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è">
                    –¢–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è
                </button>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-group">
                <input type="text" class="chat-input" id="chatInput"
                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.layout-container {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 25px;
    height: calc(100vh - 200px);
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å */
.compact-calendar {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f4ff;
    height: fit-content;
}

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 0 5px;
}

.nav-btn {
    background: linear-gradient(135deg, #f0f4ff, #e6eeff);
    border: none;
    border-radius: 10px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #5d6afb;
    font-size: 12px;
}

.nav-btn:hover {
    background: linear-gradient(135deg, #5d6afb, #764ba2);
    color: white;
    transform: translateY(-1px);
}

.month-year {
    font-size: 16px;
    font-weight: 600;
    color: #5d6afb;
    text-align: center;
    flex: 1;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
}

.day-header {
    font-weight: 600;
    color: #764ba2;
    padding: 8px 0;
    font-size: 11px;
    border-bottom: 1px solid #f0f4ff;
}

.day {
    padding: 8px 0;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    font-weight: 500;
    position: relative;
    border: 1px solid transparent;
    font-size: 13px;
}

.day:hover {
    background: #f8f9ff;
    transform: translateY(-1px);
    border-color: #e6eeff;
}

.current-day {
    background: linear-gradient(135deg, #5d6afb, #764ba2);
    color: white;
    box-shadow: 0 2px 8px rgba(93, 106, 251, 0.3);
}

.other-month {
    color: #bdc3c7;
    opacity: 0.6;
}

.has-entry::after {
    content: '';
    position: absolute;
    bottom: 3px;
    left: 50%;
    transform: translateX(-50%);
    width: 3px;
    height: 3px;
    background: #5d6afb;
    border-radius: 50%;
}

.current-day.has-entry::after {
    background: white;
}

/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —á–∞—Ç */
.expanded-chat {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f4ff;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header {
    padding: 20px 25px 15px;
    border-bottom: 1px solid #f0f4ff;
}

.message-header {
    font-weight: 600;
    color: #5d6afb;
    font-size: 18px;
}

.chat-messages {
    flex: 1;
    padding: 20px 25px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 400px;
}

.message {
    padding: 15px 20px;
    border-radius: 12px;
    max-width: 80%;
}

.ai-message {
    background: linear-gradient(135deg, #f0f4ff, #e6eeff);
    border-left: 3px solid #5d6afb;
    align-self: flex-start;
}

.message-content {
    font-size: 14px;
    line-height: 1.5;
    color: #2c3e50;
}

.message-content p {
    margin-bottom: 8px;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.message-time {
    font-size: 11px;
    color: #95a5a6;
    margin-top: 8px;
    text-align: right;
}

/* –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã */
.quick-questions {
    padding: 15px 25px;
    border-top: 1px solid #f0f4ff;
    border-bottom: 1px solid #f0f4ff;
    background: #fafbff;
}

.questions-title {
    font-size: 13px;
    font-weight: 600;
    color: #5d6afb;
    margin-bottom: 10px;
}

.questions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.question-btn {
    background: white;
    border: 1px solid #e6eeff;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: #5d6afb;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.question-btn:hover {
    background: #f0f4ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(93, 106, 251, 0.1);
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
.chat-input-container {
    padding: 20px 25px;
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.chat-input {
    flex: 1;
    border: 1px solid #e6eeff;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fafbff;
}

.chat-input:focus {
    outline: none;
    border-color: #5d6afb;
    box-shadow: 0 0 0 3px rgba(93, 106, 251, 0.1);
    background: white;
}

.send-btn {
    background: linear-gradient(135deg, #5d6afb, #764ba2);
    border: none;
    border-radius: 12px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(93, 106, 251, 0.3);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.day {
    animation: fadeIn 0.3s ease-out;
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
.chat-messages::-webkit-scrollbar {
    width: 4px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c5c5c5;
    border-radius: 2px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
class Calendar {
    constructor() {
        this.currentDate = new Date();
        this.currentYear = this.currentDate.getFullYear();
        this.currentMonth = this.currentDate.getMonth();
        this.currentDay = this.currentDate.getDate();
        this.init();
    }

    init() {
        this.renderCalendar();
        this.setupEventListeners();
        this.setupChat();
    }

    getMonthName(month) {
        const months = [
            '–Ø–ù–í–ê–†–¨', '–§–ï–í–†–ê–õ–¨', '–ú–ê–†–¢', '–ê–ü–†–ï–õ–¨', '–ú–ê–ô', '–ò–Æ–ù–¨',
            '–ò–Æ–õ–¨', '–ê–í–ì–£–°–¢', '–°–ï–ù–¢–Ø–ë–†–¨', '–û–ö–¢–Ø–ë–†–¨', '–ù–û–Ø–ë–†–¨', '–î–ï–ö–ê–ë–†–¨'
        ];
        return months[month];
    }

    getDayNames() {
        return ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
    }

    getFirstDayOfMonth(year, month) {
        const day = new Date(year, month, 1).getDay();
        return day === 0 ? 6 : day - 1; // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É –ü–ù=0, –í–°=6
    }

    getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    generateCalendarDays() {
        const days = [];
        const firstDay = this.getFirstDayOfMonth(this.currentYear, this.currentMonth);
        const daysInMonth = this.getDaysInMonth(this.currentYear, this.currentMonth);

        // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const prevMonthDays = this.getDaysInMonth(this.currentYear, this.currentMonth - 1);
        for (let i = firstDay - 1; i >= 0; i--) {
            days.push({
                day: prevMonthDays - i,
                isCurrentMonth: false,
                isToday: false
            });
        }

        // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        for (let i = 1; i <= daysInMonth; i++) {
            const isToday = i === this.currentDay &&
                           this.currentMonth === new Date().getMonth() &&
                           this.currentYear === new Date().getFullYear();
            days.push({
                day: i,
                isCurrentMonth: true,
                isToday: isToday
            });
        }

        // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const totalCells = 42;
        const nextMonthDays = totalCells - days.length;
        for (let i = 1; i <= nextMonthDays; i++) {
            days.push({
                day: i,
                isCurrentMonth: false,
                isToday: false
            });
        }

        return days;
    }

    renderCalendar() {
        const monthYearElement = document.getElementById('currentMonthYear');
        const calendarGrid = document.getElementById('calendarGrid');

        monthYearElement.textContent = `${this.getMonthName(this.currentMonth)} ${this.currentYear}`;
        calendarGrid.innerHTML = '';

        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π
        this.getDayNames().forEach(dayName => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.textContent = dayName;
            calendarGrid.appendChild(dayHeader);
        });

        // –î–æ–±–∞–≤–∏—Ç—å –¥–Ω–∏
        const days = this.generateCalendarDays();
        days.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'day';
            dayElement.textContent = day.day;

            if (!day.isCurrentMonth) {
                dayElement.classList.add('other-month');
            }

            if (day.isToday) {
                dayElement.classList.add('current-day');
            }

            // –°–ª—É—á–∞–π–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            if (day.isCurrentMonth && Math.random() > 0.7) {
                dayElement.classList.add('has-entry');
            }

            dayElement.addEventListener('click', () => this.handleDayClick(day));
            calendarGrid.appendChild(dayElement);
        });
    }

    handleDayClick(day) {
        if (!day.isCurrentMonth) return;

        document.querySelectorAll('.day').forEach(d => {
            d.classList.remove('current-day');
        });

        event.target.classList.add('current-day');

        const selectedDate = new Date(this.currentYear, this.currentMonth, day.day);
        this.addMessage(`–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: ${selectedDate.toLocaleDateString('ru-RU')}`);
    }

    changeMonth(direction) {
        this.currentMonth += direction;

        if (this.currentMonth > 11) {
            this.currentMonth = 0;
            this.currentYear++;
        } else if (this.currentMonth < 0) {
            this.currentMonth = 11;
            this.currentYear--;
        }

        this.renderCalendar();
    }

    setupEventListeners() {
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.changeMonth(-1);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            this.changeMonth(1);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                this.changeMonth(-1);
            } else if (e.key === 'ArrowRight') {
                this.changeMonth(1);
            }
        });
    }

    setupChat() {
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const questionBtns = document.querySelectorAll('.question-btn');

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        const sendMessage = () => {
            const message = chatInput.value.trim();
            if (message) {
                this.addMessage(message, 'user');
                chatInput.value = '';

                // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò
                setTimeout(() => {
                    this.addMessage(this.generateAIResponse(message), 'ai');
                }, 1000);
            }
        };

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        questionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.getAttribute('data-question');
                this.addMessage(question, 'user');

                setTimeout(() => {
                    this.addMessage(this.generateAIResponse(question), 'ai');
                }, 1000);
            });
        });
    }

    addMessage(text, type = 'ai') {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');

        messageDiv.className = `message ${type === 'ai' ? 'ai-message' : 'user-message'}`;
        messageDiv.innerHTML = `
            <div class="message-content">${text}</div>
            <div class="message-time">—Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if (type === 'user') {
            messageDiv.style.alignSelf = 'flex-end';
            messageDiv.style.background = 'linear-gradient(135deg, #5d6afb, #764ba2)';
            messageDiv.style.color = 'white';
            messageDiv.style.borderLeft = '3px solid #764ba2';
        }
    }

    generateAIResponse(question) {
        const responses = {
            '–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?': '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –∑–∞—Ä—è–¥–∫—É, –ø–æ—Å–ª—É—à–∞—Ç—å –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É. –ò–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ –≤—ã–π—Ç–∏ –Ω–∞ –ø—Ä–æ–≥—É–ª–∫—É –∏ –ø–æ–¥—ã—à–∞—Ç—å —Å–≤–µ–∂–∏–º –≤–æ–∑–¥—É—Ö–æ–º ',
            '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ?': '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –≥–ª—É–±–æ–∫–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è: –≤–¥–æ—Ö –Ω–∞ 4 —Å—á–µ—Ç–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 4, –≤—ã–¥–æ—Ö –Ω–∞ 6 ',
            '–ö–∞–∫ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Ç—Ä–µ–≤–æ–≥–æ–π?': '–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–º –º–æ–º–µ–Ω—Ç–µ. –ù–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ, 4 –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ, 3 –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–∑–µ–º–ª–∏—Ç—å—Å—è ',
            '–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —Ç–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è': '–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ "–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ": –≤–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –ø–∞—É–∑–∞ 4 —Å–µ–∫ ‚Üí –≤—ã–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –ø–∞—É–∑–∞ 4 —Å–µ–∫. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 5-10 —Ä–∞–∑ '
        };

        return responses[question] || '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ç–æ–º, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç? üí´';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    new Calendar();
});
</script>
{% endblock %}